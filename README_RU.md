![alt text](https://github.com/shapoapps/assets/blob/master/very_small_banner1.jpg)
# bash скрипт для резервного копирования сайтов и баз данных :  

### Инструкция по установке, настройке скрипта резервного копирования.


[English documentation](https://github.com/shapoapps/backup_websites_mysql/blob/master/README.md)

<br>

#### Структура каталогов по умолчанию:<br>

#### Скрипты для сервера
/myscripts/backup - каталог для хранения резервных копий файлов<br>
/myscripts/backup_bd - каталог для хранения резервных копий баз данных<br>
.../databases_to_backup.txt - файл с именами баз данных для резервного копирования<br>
.../file_cleaner.sh - скрипт для автоматического удаления файлов старше n дней<br>
.../files_to_backup.txt - файл с путями к каталогам, для резервного копирования для скрипта fullbackup.sh<br>
.../folders_for_clear.txt - файл с путями к каталогам, для автоматического удаления файлов для скрипта file_cleaner.sh<br>
.../folders_skeleton.txt - файл содержит пути к каталогам, структуру которых надо сохранить, рекурсивно, без имен файлов.<br>
.../fullbackup.sh - скрипт для выполнения резервного копирования каталогов и баз данных<br>
.../view_databases_name.sh - скрипт для просмотра списка баз данных MySQL в системе<br>
.../middleware_fullbackup.sh - скрипт посредник для запуска скрпита fullbackup.sh от имени другого linux пользователя, например при использовании с cron<br>

<br> <br>

#### Скрпиты для компьютера хранилища
.../download_backups.sh - скрипт для скачивания файлов резервных копий с вашего сервера<br>
.../downloadbackups.log - журнал скачивания файлов резервных копий<br>
<br><br>




<b>Быстрая установка:</b><br>

На сервере, где вы хотите делать резервные копии.<br>
Создайте каталог ` /backups_server ` <br>
Создайте каталог ` /myscripts/cron ` <br>
В этом каталоге выполните - ` git clone https://github.com/shapoapps/backup_websites_mysql.git ` <br>
Создайте каталог для локального хранения резервных копий ` /backups_server ` <br>
Отредактируйте файл ` /myscripts/cron/backup_websites_mysql/server_side_scripts/fullbackup.sh ` - введите логин и пароль к серверу MySQL <br>
Отредактируйте файл ` /myscripts/cron/backup_websites_mysql/server_side_scripts/files_to_backup.txt ` - введите пути к каталогам, резервные копии которых вы хотите сделать <br>
В консоли введите ` crontab -e `<br>
В конце файла добавьте строку:<br>
` 0 3 * * * /myscripts/cron/backup_websites_mysql/server_side_scripts/fullbackup.sh ` <br>
сохраните cron файл. Теперь на вашем сервере каждый день в 3 часа ночи будет выполняться резервное копирование <br>



<br>
<br>
<b>Подробная информация:</b>
<br>
<br>
<br>





<b>1. Установка и настройка скрипта fullbackup.sh</b><br>

Предназначен для использования на VPS сервере. Создает архивы файлов и баз данных.<br>

<b>Настройка:</b><br>

<b>MYSQLUSER</b> = имя пользователя MySQL, который имеет доступ на чтение ко всем базам данных для резервного копирования.<br>

<b>MYSQLPASSWORD</b> = указываем пароль этого пользователя.<br>

<b>DAYS_TO_KEEP_BACKUPS_ON_SERVER</b>=7  количество дней, сколько хранятся созданные архивы на сервере.<br>

<b>DB_MODE_FLAG</b>=2 режим резервного копирования баз данных. Если = 1, скрипт получает имена баз данных для резервного копирования из текстового файла databases_to_backup.txt . 
Если <> 1 тогда скрипт выполняет резервное копирование всех баз данных MySQL. <br>



<b>sites_array</b>=(/mysite1.com/ /mysite2.com/ /mysite3.com/)<br>
Массив с названиями сайтов. При чтении пути для архивирования, скрипт проверяет на совпадение с одним из имен в этом массиве,
если совпадение есть, в имя файла будет добавлено имя сайта, без символов "/". Если при архивации очередного каталога, совпадение
с именем сайта не найдено, файлу будет присвоено имя формата: 26.12.19--08-48-29-undefined_site-backup.zip <br>

<b>FOLDERS</b>=$CURDIR/files_to_backup.txt<br>
Имя файла с путями для резервного копирования.<br>


<b>DATABASES</b>=$CURDIR/databases_to_backup.txt<br>
Имя файла с именами баз данных для резервного копирования. Для быстрого просмотра имен всех баз данных в системе, используйте view_databases_name.sh .<br>


<b>FOLDERS_STRUCTURE_TO_STORE</b>=$CURDIR/folders_skeleton.txt<br>
Имя файла с путями к каталогам, скелет которых необходимо сохранить( имена всех вложенных каталогов без имен файлов).<br> 


<b>ARCHIVED_FILES_FOLDER</b>=/backups_server<br>
Каталог для хранения заархивированных файлов каталогов, относительно текущего каталога.<br>


<b>ARCHIVED_DATABASES_FOLDER</b>=/backups_server<br>
Каталог для хранения заархивированных файлов баз данных, относительно текущего каталога.<br>


Для работы скрипта, должен быть доступ к каталогам ` /backups_server ` - для записи.<br>

Доступ к каталогам источникам файлов - на чтение. Для разграничения пользователей, прав при использовании cron, используйте
для запуска в cron, посредник middleware_fullbackup.sh, в котором вы можете указать от имени какого пользователя он должен 
выполнять скрипт fullbackup.sh .<br>


В файл databases_to_backup.txt - нужно внести имена баз данных для резервного копирования, по одному имени в строке, как в примере.<br>

В файл files_to_backup.txt - нужно внести пути к каталогам для резервного копирования, по одному пути в строке, как в примере.<br>

Запустите fullbackup.sh , если все настроено правильно, после обработки скрипта в каталоге ` /backups_server ` - появятся файлы архивов.<br>

<br><br>

<b>2. Настройка скрипта file_cleaner.sh</b>

У скрипта должен быть доступ на запись в каталоги, из которых планируется удалять файлы.<br>

Скрипт удаляет только файлы, каталоги и вложенные каталоги остаются.<br>

При использовании очистки по cron, для разграничения прав доступа, можно использовать посредник по аналогии с middleware_fullbackup.sh .<br>

Заполните пути к каталогам для очистки в файле - folders_for_clear.txt, запустите скрипт file_cleaner.sh . 
Если все настроено правильно файлы старше n дней будут удалены.<br>

<br><br>

<b>3. Скрипт download_backups.sh </b><br>

Предназначен для скачивания резервных копий с сервера по протоколу SSH <br>

Каталоги по умолчанию:<br>
` /backups_server ` - каталог на удаленном сервере<br>
` /backups/my_development_server ` - каталог на локальном компьютере, для хранения резервных копий <br>
<br>

./download_backups.sh - поместите в любой каталог с правом записи в него .<br>
./downloadbackups.log - тот же каталог что для download_backups.sh <br>

<br>

<b>Настройка:</b><br>

<b>ARCHIVED_REMOTE_FOLDER_FILES</b>='/backups_server'<br>
Путь к каталогу с резервными копиями на удаленном сервере.<br>


<b>LOCAL_FILES_PATH</b>='/backups/my_development_server'<br>
Путь к каталогу с полученными резервными копиями файлов, на локальном компьютере.<br>


<b>SSH_CONNECTION_NAME</b>='connection_to_my_vps'<br>
Имя SSH подключения в системе. Обязательное требование, между локальным компьютером и сервером - должно быть настроено SSH подключение по ключам.<br>

<br>

При правильной настройке, после запуска скрипта download_backups.sh, в каталоге ` '/backups/my_development_server' `  появятся полученные файлы.
С сервера скачиваются только новые файлы. Можно по аналогии с middleware_fullbackup.sh - организовать работу с cron через посредника, от имени другого
пользователя.

<br><br>

<b>4. Настройка SSH подключения по имени</b><br>

После настройки подключения с локального компьютера, к нашему серверу по SSH ключам.
Нам нужно создать имя для такого подключения.

в файле /etc/ssh_config добавляем такой блок кода:<br>

` Host connection_to_my_vps ` - имя нашего SSH подключения<br>
` HostName 11.222.111.22`  - IP адрес нашего сервера<br>
` ServerAliveInterval 50 ` - не меняем<br>
` User aleks ` - имя ssh пользователя<br>
` PubKeyAuthentication yes ` - не меняем<br>
` Port 22 ` - порт на котором находится SSH служба на сервере, обычно 22 <br>
` Protocol 2 ` - не меняем<br>
` IdentityFile /home/user/.ssh/my_vps_server/ossh ` - путь к файлу с приватным ssh ключом <br>


Важный момент права доступа на файл с ключами - должны быть 600 , владелец файла с ключами и пользователь от имени которого запускаем
скрипт download_backups.sh - должны быть одинаковы. Проверьте, все ли настроено правильно.<br> 
В консоли, под пользователем, которому принадлежат ключи. Для подключения по ssh к нашему серверу достаточно ввести ` ssh connection_to_my_vps ` , и произойдет подключение, без какого либо ввода паролей.<br>
Не маловажным плюсом является криптостойкой шифрование при таком способе подключения, что дает возможность скачивать резервные копии автоматически через
любой канал интернет, в том числе публичные точки. При создании ключа лучше выбирать длину 4096 .<br>
<br>
Для успешной работы должен быть установлен rsync (в большинстве случаев установлен по умолчанию в ОС)

<br><br>

<b>Инструкция по настройке cron, для автоматического запуска резервного копирования</b><br>

На сервере, где вы создаете резервные копии.<br>

В консоли введите ` crontab -e `<br>
В конце файла добавьте строку:<br>
` 0 3 * * * /myscripts/cron/backup_websites_mysql/server_side_scripts/fullbackup.sh ` <br>
сохраните файл расписаний. Теперь на вашем сервере каждый день в 3 часа ночи будут создаваться резервные копии. <br>

<b>middleware_fullbackup.sh</b> - скрипт для запуска fullbackup.sh от имени нужного вам пользователя<br>





